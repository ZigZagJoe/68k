#include <stdint.h>
#include <stdio.h>
#include <interrupts.h>
#include <io.h>
#include <flash.h>
#include <printf.h>

// strapper-r3-jun-9
unsigned char data[] = {
  0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x08, 0x13, 0xfc, 0x00, 0xa0,
  0x00, 0x0c, 0x80, 0x00, 0x4e, 0x70, 0x20, 0x7c, 0x00, 0x08, 0x00, 0x3c,
  0x22, 0x7c, 0x00, 0x00, 0x10, 0x00, 0x30, 0x3c, 0x00, 0xff, 0x13, 0xfc,
  0x00, 0xa1, 0x00, 0x0c, 0x80, 0x00, 0x32, 0xd8, 0x51, 0xc8, 0xff, 0xfc,
  0x13, 0xfc, 0x00, 0xa2, 0x00, 0x0c, 0x80, 0x00, 0x4e, 0xf8, 0x10, 0x00,
  0x13, 0xfc, 0x00, 0xb0, 0x00, 0x0c, 0x80, 0x00, 0x13, 0xfc, 0x00, 0x01,
  0x00, 0x0c, 0x00, 0x23, 0x02, 0x39, 0x00, 0x0f, 0x00, 0x0c, 0x00, 0x1d,
  0x00, 0x39, 0x00, 0x16, 0x00, 0x0c, 0x00, 0x1d, 0x13, 0xfc, 0x00, 0x88,
  0x00, 0x0c, 0x00, 0x29, 0x13, 0xfc, 0x00, 0x01, 0x00, 0x0c, 0x00, 0x2b,
  0x13, 0xfc, 0x00, 0x01, 0x00, 0x0c, 0x00, 0x2d, 0x30, 0x7c, 0x20, 0x00,
  0x13, 0xfc, 0x00, 0xb1, 0x00, 0x0c, 0x80, 0x00, 0x08, 0x39, 0x00, 0x07,
  0x00, 0x0c, 0x00, 0x2b, 0x67, 0xf6, 0x10, 0x39, 0x00, 0x0c, 0x00, 0x2f,
  0x13, 0xc0, 0x00, 0x0c, 0x80, 0x00, 0x08, 0x39, 0x00, 0x00, 0x00, 0x0c,
  0x00, 0x01, 0x66, 0x00, 0x00, 0x1a, 0xb0, 0x3c, 0x00, 0xcb, 0x67, 0x00,
  0x00, 0x1c, 0xb0, 0x3c, 0x00, 0xcf, 0x67, 0xc4, 0x13, 0xfc, 0x00, 0xbc,
  0x00, 0x0c, 0x80, 0x00, 0x60, 0xc6, 0x13, 0xc0, 0x00, 0x0c, 0x00, 0x2f,
  0x10, 0xc0, 0x60, 0xbc, 0x13, 0xfc, 0x00, 0xbb, 0x00, 0x0c, 0x80, 0x00,
  0x4e, 0xf8, 0x20, 0x00
};

unsigned int data_len = 208;

void mem_dump(uint8_t *addr, uint32_t cnt) {
    int c = 0;
    char ascii[17];
    ascii[16] = 0;
    
    putc('\n');
    
    printf("%8X   ", addr);
    for (uint32_t i = 0; i < cnt; i++) {
        uint8_t b = *addr;
        
        ascii[c] = (b > 31 & b < 127) ? b : '.';
        
        printf("%02X ",b);
        
        addr++;
        
        if (++c == 16) {
            puts("  ");
            puts(ascii);
            putc('\n');
            if ((i+1) < cnt)
                printf("%8X   ", addr);
            c = 0;
        }
    }
    
    if (c < 15) putc('\n');
}

int main() {
    TIL311 = 0x00;
    
    serial_start(SERIAL_SAFE);
    sei();

    mem_dump(0x80000,256);
   
    flash_arm(FLASH_ARM);
    flash_erase_sector(0);
    
  	mem_dump(0x80000,256);
   
    for (uint32_t i = 0; i < data_len; i++) {
    	flash_write_byte(ADDR(0x80000 + i), data[i]);
    	if (MEM(0x80000 + i) != data[i])
    		TIL311 = 0xEE;
    }
    
    flash_arm(0);
    
    mem_dump(0x80000,256);
   
    TIL311 = 0xFF;
    while(1);
}
